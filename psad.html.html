<!DOCTYPE html>
<html>
<head>
  <title>PSAD Exam Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #e3f2fd;
    }
    .container {
      display: grid;
      grid-template-columns: 2fr 1fr 1.5fr;
      gap: 20px;
      padding: 20px;
    }
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    .left-column::before {
  content: "";
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: url('https://i.imgur.com/64Hb262.png') center center no-repeat;
  background-size: cover;
  opacity: 0.1; /* adjust to taste */
  pointer-events: none; /* ensures clicks pass through */
}
    .middle-column {
      background: white;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .sidebar {
      background: #ffffff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .sidebar h3 {
      margin-top: 0;
    }
    .sidebar img {
      width: 72px;
      border-radius:0%;
      box-shadow: 0 0 0px #888;
      margin-bottom: 0px;
    }
    input, button {
      font-size: 14px;
      margin: 6px 4px;
      padding: 6px 12px;
    }
    .correct { background-color: #e0f7e9; }
    .incorrect { background-color: #fce4e4; }
    .choiceBlock { margin: 12px 0; padding: 10px; }
    .score { font-weight: bold; margin-top: 20px; }
    .figure img {
      width: 100%;
      max-width: 300px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      margin-top: 10px;
    }
    .solution-summary h3 {
      margin-top: 0;
    }
    .solution-summary ul {
      list-style-type: none;
      padding-left: 0;
    }
    .solution-summary li {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-column">
      <h2>📝 PSAD Exam Generator</h2>
      <label>Password:
        <input id="password" type="password" />
      </label>
      <button onclick="verifyPassword()">🔍 Verify Password</button>
      <div id="statusBox">🔒 Enter password then click Verify.</div>
      <label>Number of Situations:
        <input id="count" type="number" min="1" value="1" />
      </label>
      <button id="genBtn" onclick="generateExam()" disabled>🎲 Generate New Exam</button>
      <button id="plainBtn" onclick="generatePlainExam()" style="display:none;">📄 Generate Plain Exam</button>
      <button id="submitBtn" onclick="submitAnswers()" disabled>✅ Submit Answers</button>
      <button id="keyBtn" onclick="generateAnswerKey()" style="display:none;">🧠 Generate Answer Key</button>
      <div class="score" id="scoreBox"></div>
      <div id="examContainer"></div>
    </div>

    <div class="middle-column">
      <div class="solution-summary">
        <h3>📺 Video Solutions</h3>
        <div id="solutionSummary">
          <p>Submit your answers to see video solutions here.</p>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <h3>📺 YouTube Solutions</h3>
      <a href="https://www.youtube.com/@engrclidez" target="_blank">
        <img src="https://i.imgur.com/4JkP3rZ.png" alt="YouTube Channel" />
        <div>@engrclidez</div>
      </a>
      <hr>
      <h3>🛒 Recommended Tools</h3>
      <p>
        This website is a passion project by Engr. Janclyde Espinosa, created to help students and professionals alike. If you find it valuable, please consider supporting its development by using the links below to purchase a pen tablet, calculator, or CE references. Using these links comes at no extra cost to you, but it helps the creator expand the problem database and continue to improve this tool. 🙂
      </p>
      <ul>
        <li>
          <a href="https://youtu.be/M5PvGnAYu2c" target="_blank">
            🖊️ Pen Tablet (Buy Now)
          </a>
          <div class="tool-images">
            <img src="https://i.imgur.com/I1ppnn5.jpeg" alt="Pen Tablet Image 1">
            <img src="https://i.imgur.com/v2UP75b.jpeg" alt="Pen Tablet Image 2">
          </div>
        </li>
        <li>
          <a href="https://youtu.be/M5PvGnAYu2c" target="_blank">
            📐 Engineering Calculator (Buy Now)
          </a>
          <div class="tool-images">
            <img src="https://i.imgur.com/915kBPC.jpeg" alt="Engineering Calculator Image 1">
          </div>
        </li>
        <li>
          <a href="https://youtu.be/M5PvGnAYu2c" target="_blank">
            🖥️ CE Board Exam Reference (Gillesania and Besavilla) (Buy Now)
          </a>
          <div class="tool-images">
            <img src="https://i.imgur.com/VxN44Wr.jpeg" alt="Drawing Monitor Image 1">
            <img src="https://i.imgur.com/dvV3uqw.jpeg" alt="Drawing Monitor Image 2">
          </div>
        </li>
      </ul>
    </div>
  </div>

  <script>
    const BACKEND = 'https://script.google.com/macros/s/AKfycbxLw0Kyfp1GdCH5d9um6Ss4L7IIsePsuCYnPsqboBjGUTPIpdxHJ8SmvEBpqt74BGSp/exec';
    let verified = false;
    let isAdmin = false;
    let submitted = false;
    let answerKey = [];
    let lastMode = "regular";

    function verifyPassword() {
      const pw = document.getElementById("password").value.trim();
      const box = document.getElementById("statusBox");
      if (!pw) return box.textContent = "🔒 Please enter a password.";

      fetch(`${BACKEND}?action=status&password=${encodeURIComponent(pw)}`)
        .then(res => res.json())
        .then(data => {
          if (data.status === "admin") {
            isAdmin = true;
            verified = true;
            enableButtons();
            box.textContent = "✅ Admin access: Unlimited generations.";
            document.getElementById("plainBtn").style.display = "inline-block";
            document.getElementById("keyBtn").style.display = "inline-block";
          } else if (data.status === "valid") {
            verified = true;
            box.textContent = `📆 Generations left today: ${data.remaining}`;
            enableButtons();
          } else if (data.status === "expired") {
            box.textContent = "❌ Subscription expired.";
            disableButtons();
          } else {
            box.textContent = "❌ Invalid password.";
            disableButtons();
          }
        })
        .catch(() => {
          box.textContent = "❌ Error connecting to backend.";
          disableButtons();
        });
    }

    function enableButtons() {
      document.getElementById("genBtn").disabled = false;
      document.getElementById("submitBtn").disabled = false;
    }

    function disableButtons() {
      document.getElementById("genBtn").disabled = true;
      document.getElementById("submitBtn").disabled = true;
    }

    function generateExam() {
      if (!verified) return;
      submitted = false;
      lastMode = "regular";
      document.getElementById("scoreBox").textContent = "";
      const n = document.getElementById("count").value;
      const pw = document.getElementById("password").value.trim();
      document.getElementById("examContainer").innerHTML = "⏳ Generating exam...";

      fetch(`${BACKEND}?action=generate&count=${n}&password=${encodeURIComponent(pw)}`)
        .then(res => res.text())
        .then(html => {
          if (html === "UNAUTHORIZED") {
            document.getElementById("examContainer").innerHTML = "❌ Limit reached or unauthorized.";
            return;
          }
          document.getElementById("examContainer").innerHTML = html;
          fetch(`${BACKEND}?action=key&count=${n}&password=${encodeURIComponent(pw)}`)
            .then(res => res.json())
            .then(data => { answerKey = data; });
        });
    }

    function generatePlainExam() {
      if (!isAdmin) return;
      submitted = false;
      lastMode = "plain";
      document.getElementById("scoreBox").textContent = "";
      const n = document.getElementById("count").value;
      const pw = document.getElementById("password").value.trim();
      document.getElementById("examContainer").innerHTML = "⏳ Generating plain exam...";

      fetch(`${BACKEND}?action=plain&count=${n}&password=${encodeURIComponent(pw)}`)
        .then(res => res.text())
        .then(html => {
          document.getElementById("examContainer").innerHTML = html;
          fetch(`${BACKEND}?action=key&count=${n}&password=${encodeURIComponent(pw)}`)
            .then(res => res.json())
            .then(data => { answerKey = data; });
        });
    }
function submitAnswers() {
  if (submitted || lastMode === "plain") return;
  submitted = true;
  let correct = 0;
  const solutionList = document.createElement("ul");
  const printedSituations = new Set(); // ✅ Track printed situations

  answerKey.forEach((ans, i) => {
    const selected = document.querySelector(`input[name='q${i}']:checked`);
    const block = document.getElementById(`qBlock${i}`);
    const label = document.createElement("div");
    label.style.marginTop = "6px";

    if (!selected) {
      block.classList.add("incorrect");
      label.innerHTML = `❌ No answer selected. ✔ Correct Answer: ${ans}`;
    } else {
      const val = selected.value;
      if (val === ans) {
        block.classList.add("correct");
        correct++;
        label.innerHTML = `✔ Correct Answer: ${val}`;
      } else {
        block.classList.add("incorrect");
        label.innerHTML = `❌ Your Answer: ${val} &nbsp;&nbsp;✔ Correct Answer: ${ans}`;
      }
    }
    block.appendChild(label);

    const figureLink = block.getAttribute('data-figure');
    const situationNumber = getSituationNumber(block);

    if (!printedSituations.has(situationNumber)) {
      printedSituations.add(situationNumber);
      const listItem = document.createElement("li");
      let linksHtml = '';

      if (figureLink) {
        const links = figureLink.split(/\s+/); // split on whitespace
        links.forEach(link => {
          if (link.includes("youtube.com") || link.includes("youtu.be")) {
            const videoId = extractYouTubeVideoId(link);
            const thumbnail = videoId
              ? `<img src="https://img.youtube.com/vi/${videoId}/0.jpg" style="width:120px;vertical-align:middle;margin-right:10px;">`
              : "";
            linksHtml += `<div><a href="${link}" target="_blank">▶️ Watch on YouTube</a><br>${thumbnail}</div>`;
          } else if (link.includes("facebook.com")) {
            linksHtml += `<div><a href="${link}" target="_blank">📘 View on Facebook</a></div>`;
          }
        });
      }

      if (!linksHtml) {
        linksHtml = `No solution available yet. Will be added at a later time.`;
      }

      listItem.innerHTML = `Situation ${situationNumber}:<br>${linksHtml}`;
      solutionList.appendChild(listItem);
    }
  });

  const summaryContainer = document.getElementById("solutionSummary");
  summaryContainer.innerHTML = "";
  summaryContainer.appendChild(solutionList);

  document.getElementById("scoreBox").textContent = `✅ You got ${correct} out of ${answerKey.length} items correct.`;
}

    function getSituationNumber(block) {
      let prev = block.previousElementSibling;
      while (prev) {
        if (prev.textContent && prev.textContent.startsWith("Situation")) {
          const match = prev.textContent.match(/Situation\s+(\d+)/);
          return match ? match[1] : '?';
        }
        prev = prev.previousElementSibling;
      }
      return '?';
    }

    function extractYouTubeVideoId(link) {
      try {
        const urlObj = new URL(link);
        if (urlObj.hostname.includes("youtu.be")) {
          return urlObj.pathname.slice(1).split("?")[0];
        } else if (urlObj.hostname.includes("youtube.com") && urlObj.searchParams.has("v")) {
          return urlObj.searchParams.get("v");
        }
      } catch (e) {
        return '';
      }
      return '';
    }

    function generateAnswerKey() {
      if (!isAdmin) return;
      const container = document.getElementById("examContainer");
      const keyBlock = document.createElement("div");
      keyBlock.style.marginTop = "20px";
      keyBlock.innerHTML = `<h3>🧠 Answer Key</h3><ol>` + answerKey.map(a => `<li>${a}</li>`).join('') + `</ol>`;
      container.appendChild(keyBlock);
    }

    fetch(`${BACKEND}?action=max`)
      .then(res => res.text())
      .then(max => {
        const input = document.getElementById("count");
        input.max = max;
        input.value = max;
      });
  </script>
</body>
</html>
